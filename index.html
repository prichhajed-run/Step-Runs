<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Run Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; text-align: center; }
    #map { height: 300px; margin: 10px; }
    .stats { margin: 5px; font-size: 18px; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <h2>üèÉ Run Tracker</h2>

  <div class="stats">Time: <span id="time">0:00</span></div>
  <div class="stats">Distance: <span id="distance">0.00</span> km</div>
  <div class="stats">Pace: <span id="pace">0:00</span> min/km</div>
  <div class="stats">Steps: <span id="steps">0</span></div>
  <div class="stats">Avg Cadence: <span id="cadence">0</span> spm</div>
  <div class="stats">Avg Stride: <span id="stride">0</span> cm</div>
  <div class="stats">Place: <span id="place">-</span></div>

  <div id="map"></div>

  <button onclick="startRun()">‚ñ∂ Start</button>
  <button onclick="stopRun()">‚èπ Stop</button>
  <button onclick="saveSummary()">üíæ Save Summary</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    let map, path, watchId;
    let distance = 0, lastLatLng = null;
    let startTime, elapsed = 0;
    let stepCount = 0;
    let stepListener = null;

    function initMap() {
      map = L.map('map').setView([20.5937, 78.9629], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
      }).addTo(map);
      path = L.polyline([], { color: 'blue' }).addTo(map);
    }

    function startRun() {
      distance = 0; stepCount = 0; elapsed = 0;
      lastLatLng = null; path.setLatLngs([]);
      startTime = Date.now();
      document.getElementById("steps").innerText = 0;
      document.getElementById("distance").innerText = "0.00";
      document.getElementById("pace").innerText = "0:00";
      document.getElementById("cadence").innerText = 0;
      document.getElementById("stride").innerText = 0;
      document.getElementById("place").innerText = "-";

      // Track GPS
      watchId = navigator.geolocation.watchPosition(updatePosition);

      // Track steps (motion sensor)
      if (window.DeviceMotionEvent) {
        stepListener = function(event) {
          let acc = event.accelerationIncludingGravity;
          if (acc.x > 12 || acc.y > 12 || acc.z > 12) {
            stepCount++;
            document.getElementById("steps").innerText = stepCount;
          }
        };
        window.addEventListener("devicemotion", stepListener);
      }

      // Timer update
      timer = setInterval(updateTime, 1000);
    }

    function stopRun() {
      navigator.geolocation.clearWatch(watchId);
      if (stepListener) window.removeEventListener("devicemotion", stepListener);
      clearInterval(timer);
    }

    function updatePosition(pos) {
      let lat = pos.coords.latitude;
      let lon = pos.coords.longitude;
      let latlng = [lat, lon];

      if (lastLatLng) {
        distance += map.distance(lastLatLng, latlng) / 1000;
        document.getElementById("distance").innerText = distance.toFixed(2);

        // Pace in min/km
        let mins = (elapsed / 1000) / 60;
        if (distance > 0) {
          let pace = mins / distance;
          let paceMin = Math.floor(pace);
          let paceSec = Math.round((pace - paceMin) * 60);
          if (paceSec < 10) paceSec = "0" + paceSec;
          document.getElementById("pace").innerText = paceMin + ":" + paceSec;
        }
      }

      lastLatLng = latlng;
      path.addLatLng(latlng);
      map.setView(latlng, 16);

      // Place name (reverse geocode once every update)
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
        .then(r => r.json())
        .then(data => {
          document.getElementById("place").innerText = data.display_name || "Unknown";
        });
    }

    function updateMetrics() {
      if (elapsed > 0 && stepCount > 0) {
        let cadence = stepCount / ((elapsed / 1000) / 60);
        document.getElementById("cadence").innerText = cadence.toFixed(0);

        let stride = (distance * 1000) / stepCount * 100; // cm
        document.getElementById("stride").innerText = stride.toFixed(0);
      }
    }

    function updateTime() {
      elapsed = Date.now() - startTime;
      let secs = Math.floor(elapsed / 1000);
      let mins = Math.floor(secs / 60);
      secs = secs % 60;
      document.getElementById("time").innerText = mins + ":" + (secs < 10 ? "0" : "") + secs;
      updateMetrics();
    }

    function saveSummary() {
      leafletImage(map, function(err, mapCanvas) {
        if (err) return console.error(err);

        // Stats screenshot (ignore map to avoid duplication)
        html2canvas(document.body, { ignoreElements: el => el.id === "map" }).then(statsCanvas => {
          let finalCanvas = document.createElement("canvas");
          finalCanvas.width = statsCanvas.width;
          finalCanvas.height = statsCanvas.height + mapCanvas.height;

          let ctx = finalCanvas.getContext("2d");
          ctx.drawImage(statsCanvas, 0, 0);
          ctx.drawImage(mapCanvas, 0, statsCanvas.height);

          let link = document.createElement("a");
          link.download = "workout_summary.png";
          link.href = finalCanvas.toDataURL("image/png");
          link.click();
        });
      });
    }

    initMap();
  </script>
</body>
</html>


