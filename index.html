<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Run Tracker ‚Äî Robust Reset</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:12px; background:#f7f7f7; color:#111; }
  h1 { margin:0 0 8px 0; font-size:20px; color: #0a4; text-align:center; }
  .panel { background: #fff; border-radius:8px; padding:10px; box-shadow:0 1px 4px rgba(0,0,0,0.08); margin-bottom:10px; }
  .stats-row { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; align-items:center; }
  .stat { min-width:110px; padding:8px 10px; border-radius:6px; background:#fafafa; font-size:14px; text-align:center; box-shadow:0 0 0 1px rgba(0,0,0,0.03) inset; }
  .controls { text-align:center; margin-top:8px; }
  button { margin:6px 6px; padding:10px 14px; font-size:15px; border-radius:7px; border:none; background:#007bff; color:white; }
  button.secondary { background:#6c757d; }
  #map { height:360px; margin-top:10px; border-radius:8px; overflow:hidden; border:1px solid #ddd; }
  #splits { margin-top:10px; padding:8px; background:#fff; border-radius:8px; color:#111; font-size:14px; text-align:left; max-height:140px; overflow:auto; border:1px solid #eee; }
  #splits h3 { margin:0 0 6px 0; font-size:15px; }
  .small { font-size:12px; color:#555; }
</style>
</head>
<body>
  <h1>üèÉ Run Tracker</h1>

  <!-- Top panel: stats + controls -->
  <div class="panel" id="statsPanel">
    <div class="stats-row">
      <div class="stat">Time<br><strong id="time">0:00</strong></div>
      <div class="stat">Distance<br><strong id="distance">0.00</strong> km</div>
      <div class="stat">Live Pace<br><strong id="livepace">0:00</strong> min/km</div>
      <div class="stat">Avg Pace<br><strong id="avgpace">0:00</strong> min/km</div>
      <div class="stat">Steps<br><strong id="steps">0</strong></div>
      <div class="stat">Avg Cadence<br><strong id="cadence">0</strong> spm</div>
      <div class="stat">Avg Stride<br><strong id="stride">0</strong> cm</div>
    </div>

    <div class="controls">
      <button id="btnStart">‚ñ∂ Start</button>
      <button id="btnPause" class="secondary">‚è∏ Pause</button>
      <button id="btnReset" class="secondary">üîÑ Reset</button>
      <button id="btnSave">üì∏ Save Summary</button>
    </div>
  </div>

  <div id="map" class="panel"></div>

  <div id="splits" class="panel">
    <h3>Splits</h3>
    <div id="splitsList" class="small">No splits yet</div>
  </div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
/* --- Variables --- */
let map=null, path=null, watchId=null;
let running=false, paused=false, startTime=0, elapsed=0, timer=null;
let lastPos=null, lastUpdateTime=null;
let gpsDistance=0, blendedDistance=0;
let stepCount=0, lastStepTime=0;
let splits=[], lastKm=0;
let defaultStride=0.78; // meters
let estimatedStride=defaultStride;

/* --- Init map --- */
map = L.map('map', { attributionControl:false }).setView([20.5937,78.9629],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);
path = L.polyline([], { color:'red', weight:4, opacity:0.9 }).addTo(map);

/* --- Helpers --- */
function haversine_m(lat1, lon1, lat2, lon2){
  const R=6371000;
  const toRad=x=>x*Math.PI/180;
  let dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  let a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function mmss(p){ let m=Math.floor(p), s=Math.round((p-m)*60); if(s===60){ m++; s=0;} return (m<10?'0'+m:m)+':'+(s<10?'0'+s:s); }

/* --- Update UI --- */
function updateUIAll(){
  document.getElementById('distance').innerText = (blendedDistance/1000).toFixed(2);
  let mins = elapsed/60000;
  let livePaceMpk = (blendedDistance>0)?(elapsed/1000/60)/(blendedDistance/1000):0;
  let avgPaceMpk = (blendedDistance>0)?(mins/(blendedDistance/1000)):0;
  document.getElementById('livepace').innerText = mmss(livePaceMpk);
  document.getElementById('avgpace').innerText = mmss(avgPaceMpk);
  document.getElementById('steps').innerText = stepCount;
  let cadence = (elapsed>0)?stepCount/(elapsed/60000):0;
  document.getElementById('cadence').innerText = Math.round(cadence);
  let stride = (stepCount>0)?((blendedDistance/stepCount)*100):0;
  document.getElementById('stride').innerText = Math.round(stride);
}

/* --- Splits --- */
function renderSplits(){
  let html='';
  splits.forEach(s=>{ html+=`Km ${s.km}: ${mmss(s.pace)} min/km<br>`; });
  document.getElementById('splitsList').innerHTML = html || 'No splits yet';
}

/* --- Steps --- */
function handleMotion(e){
  const acc=e.accelerationIncludingGravity||{x:0,y:0,z:0};
  let mag=Math.sqrt((acc.x||0)**2+(acc.y||0)**2+(acc.z||0)**2);
  if(mag>1.8 && Date.now()-lastStepTime>350){ stepCount++; lastStepTime=Date.now(); }
}

/* --- Start / Pause / Reset --- */
document.getElementById('btnStart').onclick=startRun;
document.getElementById('btnPause').onclick=pauseRun;
document.getElementById('btnReset').onclick=resetRun;
document.getElementById('btnSave').onclick=saveSummary;

function startRun(){
  running=true; paused=false;
  startTime=Date.now(); elapsed=0;
  lastPos=null; lastUpdateTime=null;
  gpsDistance=0; blendedDistance=0;
  stepCount=0; lastStepTime=0; splits=[]; lastKm=0; estimatedStride=defaultStride;
  path.setLatLngs([]);
  updateUIAll(); renderSplits();
  if(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission==='function'){
    DeviceMotionEvent.requestPermission().then(res=>{ if(res==='granted') window.addEventListener('devicemotion',handleMotion); });
  }else{ window.addEventListener('devicemotion',handleMotion); }
  if(navigator.geolocation){ watchId=navigator.geolocation.watchPosition(onPosition,onError,{enableHighAccuracy:true,maxAge:1000,timeout:10000}); }
  timer=setInterval(()=>{ elapsed=Date.now()-startTime; updateUIAll(); },1000);
}

function pauseRun(){
  if(!running||paused) return; paused=true;
  clearInterval(timer);
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
}

function resetRun(){
  running=false; paused=false;
  clearInterval(timer);
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  window.removeEventListener('devicemotion',handleMotion);
  elapsed=0; lastPos=null; lastUpdateTime=null;
  gpsDistance=0; blendedDistance=0; stepCount=0; splits=[]; lastKm=0; estimatedStride=defaultStride;
  path.setLatLngs([]);
  updateUIAll(); renderSplits();
}

/* --- GPS --- */
function onPosition(pos){
  let lat=pos.coords.latitude, lon=pos.coords.longitude;
  let now=Date.now();
  if(!lastPos){ lastPos={lat,lon}; lastUpdateTime=now; path.addLatLng([lat,lon]); map.setView([lat,lon],16); return; }
  let deltaT=Math.max((now-lastUpdateTime)/1000,0.001);
  let d=haversine_m(lastPos.lat,lastPos.lon,lat,lon);
  let speed=d/deltaT;
  if(d<3 || speed>12) { lastPos={lat,lon}; lastUpdateTime=now; return; } //filter jumps
  gpsDistance+=d;
  estimatedStride=(stepCount>0)?Math.max(0.3,Math.min(2.5,gpsDistance/stepCount)):defaultStride;
  let stepsDist=stepCount*estimatedStride;
  let gpsConfidence=(speed>=0.3 && speed<=6)?0.85:0.35;
  if(stepCount>20 && Math.abs(stepsDist-gpsDistance)/Math.max(1,gpsDistance)<0.4) gpsConfidence=0.9;
  blendedDistance=gpsConfidence*gpsDistance+(1-gpsConfidence)*stepsDist;

  // path + map
  path.addLatLng([lat,lon]);
  map.setView([lat,lon],16);

  // splits
  if(Math.floor(blendedDistance/1000)>lastKm){
    let newKm=Math.floor(blendedDistance/1000);
    let totalMins=(Date.now()-startTime)/60000;
    splits.push({ km:newKm, pace: totalMins/newKm });
    lastKm=newKm; renderSplits();
  }
  lastPos={lat,lon}; lastUpdateTime=now;
}

/* --- Error --- */
function onError(err){ console.warn(err.message); }

/* --- Save summary (map + stats + splits) --- */
function saveSummary(){
  // temporarily clone map div into statsPanel
  let mapClone = map.getContainer().cloneNode(true);
  mapClone.style.marginTop='10px'; mapClone.style.height='300px';
  document.getElementById('statsPanel').appendChild(mapClone);
  leafletImage(map, function(err, canvasMap){
    html2canvas(document.getElementById('statsPanel')).then(canvas=>{
      // draw map canvas over top
      let ctx=canvas.getContext('2d');
      ctx.drawImage(canvasMap,0,canvas.height-mapClone.offsetHeight,canvas.width,mapClone.offsetHeight);
      let link=document.createElement('a');
      link.href=canvas.toDataURL('image/png'); link.download='run_summary.png'; link.click();
      mapClone.remove();
    });
  });
}
</script>
</body>
</html>



