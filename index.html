<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Run Tracker ‚Äî Graphs & Splits</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { font-family: Arial, sans-serif; margin:0; padding:12px; background:#f7f7f7; color:#111; }
h1 { text-align:center; color:#0a4; margin:0 0 10px 0; }
.controls { text-align:center; margin-bottom:8px; }
button { margin:6px 6px; padding:10px 14px; font-size:15px; border-radius:7px; border:none; background:#007bff; color:white; cursor:pointer; }
button.secondary { background:#6c757d; }
#map { height:360px; border-radius:8px; overflow:hidden; border:1px solid #ddd; margin-bottom:10px; position:relative; }
.leaflet-top.leaflet-right .map-info { margin-top:8px; }
.map-info {
  background: rgba(255,255,255,0.95);
  padding:8px 10px;
  border-radius:6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  font-size:13px;
  min-width:150px;
}
.map-info b { display:block; margin-bottom:4px; }
.tabs { display:flex; margin-bottom:10px; }
.tab { flex:1; padding:10px; text-align:center; cursor:pointer; background:#eee; border-radius:6px 6px 0 0; margin-right:2px; }
.tab.active { background:#fff; border-bottom:1px solid #fff; }
.tab-content { background:#fff; border-radius:0 0 8px 8px; padding:10px; min-height:200px; border:1px solid #ddd; }
.stats-row { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
.stat { min-width:110px; padding:8px 10px; border-radius:6px; background:#fafafa; font-size:14px; text-align:center; box-shadow:0 0 0 1px rgba(0,0,0,0.03) inset; }
#splitsTable { width:100%; border-collapse:collapse; font-size:13px; }
#splitsTable th, #splitsTable td { border:1px solid #eee; padding:8px; text-align:center; }
#splitsTable th { background:#f3f3f3; font-weight:600; }
.chart-wrap { width:100%; height:200px; margin-bottom:12px; }
canvas.chart-canvas { width:100% !important; height:100% !important; display:block; }
.gps-legend { font-size:12px; margin-top:6px; color:#333; }
.gps-badge { display:inline-block; padding:3px 7px; border-radius:999px; font-weight:600; margin-left:6px; }
.gps-verygood { background:#2ecc71; color:#fff; }
.gps-good { background:#f1c40f; color:#fff; }
.gps-fair { background:#e67e22; color:#fff; }
.gps-poor { background:#e74c3c; color:#fff; }
@media (max-width:520px){ #map{height:240px;} .stat{min-width:90px; font-size:13px;} }
</style>
</head>
<body>

<h1>üèÉ Run Tracker</h1>

<div class="controls">
  <button id="btnStart">‚ñ∂ Start</button>
  <button id="btnPause" class="secondary">‚è∏ Pause</button>
  <button id="btnReset" class="secondary">üîÑ Reset</button>
  <button id="btnSave">üì∏ Save Summary</button>
</div>

<div id="map"></div>

<div class="tabs">
  <div class="tab active" data-tab="stats">Stats</div>
  <div class="tab" data-tab="graphs">Graphs</div>
  <div class="tab" data-tab="splits">Splits</div>
</div>

<div id="stats" class="tab-content">
  <div class="stats-row">
    <div class="stat">Time<br><strong id="time">0:00</strong></div>
    <div class="stat">Distance<br><strong id="distance">0.00</strong> km</div>
    <div class="stat">Live Pace<br><strong id="livepace">0:00</strong> min/km</div>
    <div class="stat">Avg Pace<br><strong id="avgpace">0:00</strong> min/km</div>
    <div class="stat">Steps<br><strong id="steps">0</strong></div>
    <div class="stat">Avg Cadence<br><strong id="cadence">0</strong> spm</div>
    <div class="stat">Avg Stride<br><strong id="stride">0</strong> cm</div>
    <div class="stat">Elev Gain<br><strong id="elevation">0</strong> m</div>
  </div>
</div>

<div id="graphs" class="tab-content" style="display:none;">
  <div class="chart-wrap"><canvas id="distanceChart" class="chart-canvas"></canvas></div>
  <div class="chart-wrap"><canvas id="timeChart" class="chart-canvas"></canvas></div>
</div>

<div id="splits" class="tab-content" style="display:none;">
  <div id="splitsList"><em>No splits yet</em></div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>
<script>
/* --------------------------
   Map
-------------------------- */
let map = L.map('map', { attributionControl:false }).setView([20.5937,78.9629],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);
let path = L.polyline([], { color:'red', weight:4, opacity:0.9 }).addTo(map);

let gpsMarker = null;
let accuracyCircle = null;
let gpsInfoControl = null;
let lastReverseGeocodeTs = 0;
const REVERSE_GEOCODE_MIN_MS = 15000; // don't call reverse geocode more than once every 15s

// Create a map control for GPS info (accuracy, strength, place name)
gpsInfoControl = L.control({ position: 'topright' });
gpsInfoControl.onAdd = function () {
  const div = L.DomUtil.create('div', 'map-info');
  div.innerHTML = `
    <b>GPS</b>
    <div>Accuracy: <span id="gpsAccuracy">‚Äî</span> m <span id="gpsBadge" class="gps-badge"></span></div>
    <div>Strength: <span id="gpsStrength">‚Äî</span></div>
    <div>Place: <span id="gpsPlace">‚Äî</span></div>
    <div class="gps-legend"><small>Accuracy circle shown on map</small></div>
  `;
  L.DomEvent.disableClickPropagation(div);
  return div;
};
gpsInfoControl.addTo(map);

/* --------------------------
   State
-------------------------- */
let running=false, paused=false, startTime=0, elapsed=0, timer=null;
let lastPos=null, lastUpdateTime=null;
let gpsDistance=0, blendedDistance=0;
let prevBlendedDistance=0, prevElapsedTime=0, prevStepCount=0;
let stepCount=0, lastStepTime=0, lastAccel=0;
let splits=[], lastSplit=0, lastSplitTime=0;
let defaultStride=0.78, estimatedStride=defaultStride;
let elevationGain=0, lastAltitude=null;
let watchId=null;
let recentDistances=[];

const LIVE_PACE_WINDOW_SEC = 10;
const MIN_MOVE_THRESHOLD_M = 1.0;
const MAX_VALID_SPEED_MPS = 6.0;
const MAX_ACCEPTABLE_ACCURACY_M = 20;

/* --------------------------
   Charts
-------------------------- */
const distanceCtx=document.getElementById('distanceChart').getContext('2d');
const timeCtx=document.getElementById('timeChart').getContext('2d');

const distanceChart = new Chart(distanceCtx,{
  type:'line',
  data:{ labels:[], datasets:[{ label:'Pace (min/km)', data:[], borderColor:'#1f77b4', tension:0.3, fill:false }] },
  options:{ responsive:true, maintainAspectRatio:false,
    scales:{ x:{ title:{ display:true, text:'Distance (m)'} }, y:{ title:{ display:true, text:'Pace (min/km)'} } }
  }
});
const timeChart = new Chart(timeCtx,{
  type:'line',
  data:{ labels:[], datasets:[{ label:'Pace (min/km)', data:[], borderColor:'#2ca02c', tension:0.3, fill:false }] },
  options:{ responsive:true, maintainAspectRatio:false,
    scales:{ x:{ title:{ display:true, text:'Time (min)'} }, y:{ title:{ display:true, text:'Pace (min/km)'} } }
  }
});

/* --------------------------
   Tabs
-------------------------- */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
    tab.classList.add('active');
    const el=document.getElementById(tab.dataset.tab);
    el.style.display='block';
    if(tab.dataset.tab==='graphs'){
      setTimeout(()=>{ distanceChart.resize(); distanceChart.update(); timeChart.resize(); timeChart.update(); },150);
    }
    if(tab.dataset.tab==='stats') setTimeout(()=>map.invalidateSize(),200);
  }
});

/* --------------------------
   Helpers
-------------------------- */
function pad2(n){ return (n<10?'0':'')+n; }
function formatSeconds(sec){ sec=Math.round(sec); let m=Math.floor(sec/60), s=sec%60; return pad2(m)+':'+pad2(s); }
function mmssFromMinutes(mins){ let m=Math.floor(mins), s=Math.round((mins-m)*60); return pad2(m)+':'+pad2(s); }

function getStrengthLabelFromAccuracy(acc){
  if(acc === null || typeof acc === 'undefined') return { label:'Unknown', cls:'' };
  if(acc <= 5) return { label: 'Excellent', cls: 'gps-verygood' };
  if(acc <= 10) return { label: 'Good', cls: 'gps-good' };
  if(acc <= 20) return { label: 'Fair', cls: 'gps-fair' };
  return { label: 'Poor', cls: 'gps-poor' };
}

/* --------------------------
   UI
-------------------------- */
function updateUIAll(){
  document.getElementById('time').innerText=formatSeconds(elapsed/1000);
  document.getElementById('distance').innerText=(blendedDistance/1000).toFixed(2);

  let avgPace=(blendedDistance>0)?(elapsed/60000)/(blendedDistance/1000):0;
  document.getElementById('avgpace').innerText=avgPace>0?mmssFromMinutes(avgPace):'0:00';

  let nowTs = Date.now();
  let windowMs = LIVE_PACE_WINDOW_SEC*1000;
  let distSum = 0, timeSum = 0;
  for(let i=recentDistances.length-1;i>=0;i--){
    const item = recentDistances[i];
    const age = nowTs - item.ts;
    if(age <= windowMs){
      distSum += item.d;
      timeSum += item.t;
    } else {
      const overlap = Math.max(0, windowMs - (nowTs - item.ts) + item.t);
      if(overlap>0 && item.t>0){
        const frac = overlap / item.t;
        distSum += item.d * frac;
        timeSum += item.t * frac;
      }
      break;
    }
  }
  let livePace = avgPace;
  if(distSum>0 && timeSum>0){
    livePace = (timeSum/60000)/(distSum/1000);
  }
  document.getElementById('livepace').innerText=livePace>0?mmssFromMinutes(livePace):'0:00';

  document.getElementById('steps').innerText=stepCount;
  document.getElementById('cadence').innerText=Math.round(elapsed>0?stepCount/(elapsed/60000):0);
  document.getElementById('stride').innerText=Math.round(stepCount>0?blendedDistance/stepCount*100:0);
  document.getElementById('elevation').innerText=Math.round(elevationGain);
}

function renderSplits(){
  if(splits.length===0){
    document.getElementById('splitsList').innerHTML='<em>No splits yet</em>';
    return;
  }
  let html = '<table id="splitsTable"><thead><tr><th>Distance (m)</th><th>Time (s)</th><th>Steps</th></tr></thead><tbody>';
  for(let i=0;i<splits.length;i++){
    const s = splits[i];
    html += `<tr><td>${s.m}</td><td>${Math.round(s.time)}</td><td>${s.steps}</td></tr>`;
  }
  html += '</tbody></table>';
  document.getElementById('splitsList').innerHTML = html;
}

/* --------------------------
   Motion
-------------------------- */
function handleMotion(e){
  const acc=e.accelerationIncludingGravity||{x:0,y:0,z:0};
  let mag=Math.sqrt((acc.x||0)**2+(acc.y||0)**2+(acc.z||0)**2);
  let delta=Math.abs(mag-lastAccel); lastAccel=mag;
  if(delta>1.2 && mag>9 && Date.now()-lastStepTime>300){
    stepCount++; lastStepTime=Date.now();
  }
}

/* --------------------------
   Run control
-------------------------- */
document.getElementById('btnStart').onclick=startRun;
document.getElementById('btnPause').onclick=pauseRun;
document.getElementById('btnReset').onclick=resetRun;

/* --------------------------
   Screenshot ‚Äî High-res all-tabs
-------------------------- */
document.getElementById('btnSave').onclick=captureAllTabsScreenshot;
function captureAllTabsScreenshot(){
  const container=document.body;
  const tabs=document.querySelectorAll('.tab-content');
  const displayBackup=[];
  tabs.forEach((t,i)=>{ displayBackup[i]=t.style.display; t.style.display='block'; });

  distanceChart.resize(); distanceChart.update();
  timeChart.resize(); timeChart.update();
  map.invalidateSize();

  leafletImage(map, function(err,mapCanvas){
    if(err){ console.error(err); return; }

    const mapDiv=document.getElementById('map');
    const originalMapDisplay=mapDiv.style.display;
    mapDiv.style.display='none';
    mapCanvas.id='mapCanvasTemp';
    mapCanvas.style.width=mapDiv.offsetWidth+'px';
    mapCanvas.style.height=mapDiv.offsetHeight+'px';
    mapDiv.parentNode.insertBefore(mapCanvas,mapDiv);

    html2canvas(container,{useCORS:true,allowTaint:true,scale:2}).then(canvas=>{
      const a=document.createElement('a'); a.href=canvas.toDataURL(); a.download='run_summary.png'; a.click();
      mapDiv.style.display=originalMapDisplay;
      mapCanvas.remove();
      tabs.forEach((t,i)=>t.style.display=displayBackup[i]);
    });
  });
}

/* --------------------------
   Run functions: start/pause/reset and GPS
-------------------------- */
function startRun(){
  if(running && paused){
    paused=false; startTime=Date.now()-elapsed;
    timer=setInterval(()=>{ elapsed=Date.now()-startTime; updateUIAll(); },1000);
    setupMotionListener(); setupGeolocationWatch(); return;
  }
  running=true; paused=false; startTime=Date.now(); elapsed=0;
  lastPos=null; lastUpdateTime=null; gpsDistance=0; blendedDistance=0;
  prevBlendedDistance=0; prevElapsedTime=0; prevStepCount=0;
  stepCount=0;
  splits=[]; lastSplit=0; lastSplitTime=0;
  estimatedStride=defaultStride;
  elevationGain=0; lastAltitude=null; recentDistances=[];
  path.setLatLngs([]);
  distanceChart.data.labels=[]; distanceChart.data.datasets[0].data=[]; distanceChart.update();
  timeChart.data.labels=[]; timeChart.data.datasets[0].data=[]; timeChart.update();
  renderSplits(); updateUIAll();
  setupMotionListener(); setupGeolocationWatch();
  timer=setInterval(()=>{ elapsed=Date.now()-startTime; updateUIAll(); },1000);
}
function pauseRun(){ if(!running||paused) return; paused=true; clearInterval(timer); timer=null; removeMotionListener(); clearGeoWatch(); }
function resetRun(){ running=false; paused=false; clearInterval(timer); timer=null; removeMotionListener(); clearGeoWatch();
  lastPos=null; lastUpdateTime=null; gpsDistance=0; blendedDistance=0;
  prevBlendedDistance=0; prevElapsedTime=0; prevStepCount=0;
  stepCount=0; splits=[]; lastSplit=0; lastSplitTime=0; estimatedStride=defaultStride;
  elevationGain=0; lastAltitude=null; recentDistances=[]; path.setLatLngs([]);
  distanceChart.data.labels=[]; distanceChart.data.datasets[0].data=[]; distanceChart.update();
  timeChart.data.labels=[]; timeChart.data.datasets[0].data=[]; timeChart.update();
  updateUIAll(); renderSplits(); map.setView([20.5937,78.9629],5);

  if(gpsMarker){ map.removeLayer(gpsMarker); gpsMarker=null; }
  if(accuracyCircle){ map.removeLayer(accuracyCircle); accuracyCircle=null; }
}

/* --------------------------
   Motion listener
-------------------------- */
function setupMotionListener(){ window.addEventListener('devicemotion',handleMotion); }
function removeMotionListener(){ window.removeEventListener('devicemotion',handleMotion); }

/* --------------------------
   GPS
-------------------------- */
function setupGeolocationWatch(){
  if(!navigator.geolocation) return alert('Geolocation not supported');
  watchId=navigator.geolocation.watchPosition(onPosition,onPositionError,{ enableHighAccuracy:true, maximumAge:500, timeout:5000 });
}
function clearGeoWatch(){ if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; } }

function onPosition(pos){
  if(!pos || !pos.coords) return;
  const lat=pos.coords.latitude, lon=pos.coords.longitude, acc=pos.coords.accuracy||0, alt=pos.coords.altitude;
  const now=Date.now();

  if(acc>MAX_ACCEPTABLE_ACCURACY_M) return;

  // update GPS distance & timestamps
  let d=0;
  if(lastPos){
    d = map.distance([lat,lon],[lastPos.lat,lastPos.lon]);
    let deltaT = (now-lastUpdateTime)/1000;
    if(deltaT>0 && d/deltaT>MAX_VALID_SPEED_MPS){ d=0; }
    gpsDistance += d;

    // --- RED PATH UPDATE ---
    path.addLatLng([lat, lon]);  // <-- this is the fix: updates red path on every valid GPS point
  } else {
    // first point
    gpsMarker = L.marker([lat,lon]).addTo(map);
    path.addLatLng([lat, lon]);
    map.setView([lat,lon],16);
  }

  lastPos={lat,lon}; lastUpdateTime=now;

  // elevation gain
  if(alt!==null && lastAltitude!==null){
    const diff = alt-lastAltitude;
    if(diff>0) elevationGain += diff;
  }
  if(alt!==null) lastAltitude=alt;

  // estimate stride
  if(stepCount>0){
    let instStride = gpsDistance/stepCount;
    instStride = Math.max(0.3, Math.min(2.5, instStride));
    estimatedStride = estimatedStride*0.85 + instStride*0.15;
  } else estimatedStride=defaultStride;

  // blended distance
  blendedDistance = Math.max(gpsDistance, stepCount*estimatedStride);

  // recent distance array for live pace
  let deltaT=(lastUpdateTime-prevUpdateTime)/1000||1;
  recentDistances.push({d:d, t:deltaT*1000, ts:now});
  if(recentDistances.length>500) recentDistances.shift();

  // update marker & accuracy
  if(gpsMarker) gpsMarker.setLatLng([lat,lon]);
  if(!accuracyCircle) accuracyCircle = L.circle([lat,lon], { radius: acc, color:'#3498db', fillColor:'#3498db', fillOpacity:0.1 }).addTo(map);
  else accuracyCircle.setLatLng([lat,lon]).setRadius(acc);

  // update GPS info panel
  document.getElementById('gpsAccuracy').innerText=acc.toFixed(1);
  const sLabel = getStrengthLabelFromAccuracy(acc);
  const gpsBadge = document.getElementById('gpsBadge');
  gpsBadge.className='gps-badge '+sLabel.cls; gpsBadge.innerText=sLabel.label;
  document.getElementById('gpsStrength').innerText=sLabel.label;

  // update UI
  updateUIAll();

  prevUpdateTime = now;
}
function onPositionError(err){ console.warn('GPS error',err); }
</script>

</body>
</html>


